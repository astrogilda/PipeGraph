

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pipegraph.base &mdash; PipeGraph 0.2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PipeGraph
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">General examples</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PipeGraph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pipegraph.base</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pipegraph.base</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># The MIT License (MIT)</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2018 Laura Fernandez Robles,</span>
<span class="c1">#                    Hector Alaiz Moreton,</span>
<span class="c1">#                    Jaime Cifuentes-Rodriguez,</span>
<span class="c1">#                    Javier Alfonso-Cendón,</span>
<span class="c1">#                    Camino Fernández-Llamas,</span>
<span class="c1">#                    Manuel Castejón-Limas</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
<span class="c1"># copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="k">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">clone</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="k">import</span> <span class="n">GaussianMixture</span>

<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">Bunch</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.metaestimators</span> <span class="k">import</span> <span class="n">_BaseComposition</span>
<span class="kn">from</span> <span class="nn">pipegraph.adapters</span> <span class="k">import</span> <span class="n">AdapterMixins</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PipeGraph"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph">[docs]</a><span class="k">class</span> <span class="nc">PipeGraph</span><span class="p">(</span><span class="n">_BaseComposition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PipeGraph class holds the steps, connections and graphs needed to perform graph-like fits and predicts.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    steps : list</span>
<span class="sd">        List of (name, action) tuples that are chained. The last one is considered to be the output step.</span>

<span class="sd">    connections: dictionary</span>
<span class="sd">        A dictionary whose keys of the top level entries of the dictionary must the same as those of the previously defined steps. The values assocciated to these keys define the variables from other steps that are going to be considered as inputs for the current step. They are dictionaries themselves, where:</span>

<span class="sd">        - The keys of the nested dictionary represents the input variable as named at the current step.</span>
<span class="sd">        - The values associated to these keys define the steps that hold the desired information, and the variables as named at that step. This information can be written as:</span>

<span class="sd">            - A tuple with the label of the step in position 0 followed by the name of the output variable in position 1.</span>
<span class="sd">            - A string representing a variable from an external source to the PipeGraphRegressor object, such as those provided by the user while invoking the fit, predict or fit_predict methods.</span>

<span class="sd">    alternative_connections: dictionary</span>
<span class="sd">        A dictionary as described for ``connections``. This parameters provides the possibility of specifying a PipeGraph</span>
<span class="sd">        that uses a different connections dictionary during fit than during predict. The default value, ``None``, implies that it is equivalent to the ``connections`` value, and thus PipeGraph uses the same graph for both ``fit`` and ``predict``.</span>

<span class="sd">    log_level: int</span>
<span class="sd">        Log level for traceability purposes. This is yet a unimplemented feature.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">fit_connections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predict_connections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="o">=</span> <span class="n">fit_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="o">=</span> <span class="n">predict_connections</span> <span class="k">if</span> <span class="n">predict_connections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fit_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="PipeGraph.inject"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.inject">[docs]</a>    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">sink_var</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="n">source_var</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="n">into</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Adds a connection to the graph.</span>

<span class="sd">                Parameters:</span>
<span class="sd">                -----------</span>
<span class="sd">                sink: Destination</span>
<span class="sd">                sink_var: Name of the variable at destination that is going to hold the information</span>
<span class="sd">                source: Origin</span>
<span class="sd">                source_var: Name of the variable at origin holding the information</span>
<span class="sd">                into: This can be either &#39;fit&#39; or &#39;predict&#39;, indicating which connections are described: those belonging</span>
<span class="sd">                      to &#39;fit_connections&#39; or those belonging to &#39;predict_connections&#39;. Default is &#39;fit&#39;.</span>

<span class="sd">                Returns:</span>
<span class="sd">                --------</span>
<span class="sd">                self:  PipeGraph</span>
<span class="sd">                    Returning self allows chaining operations</span>
<span class="sd">                &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">into</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
            <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span>
        <span class="k">elif</span> <span class="n">into</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">:</span>
            <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: into parameter must be either fit or predict.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sink</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">sink</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">sink_var</span><span class="p">:</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_var</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">sink</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sink_var</span><span class="p">:</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source_var</span><span class="p">)}</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># copied from sklearn</span>
<div class="viewcode-block" id="PipeGraph.get_params"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get parameters for this estimator.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        deep : boolean, optional</span>
<span class="sd">            If True, will return the parameters for this estimator and</span>
<span class="sd">            contained subobjects that are estimators.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : mapping of string to any</span>
<span class="sd">            Parameter names mapped to their values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span></div>

    <span class="c1"># copied from sklearn</span>
<div class="viewcode-block" id="PipeGraph.set_params"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.set_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the parameters of this estimator.</span>
<span class="sd">        Valid parameter keys can be listed with ``get_params()``.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PipeGraph.fit"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the PipeGraph steps one after the other and following the topological order of the graph defined by the connections attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: iterable object</span>
<span class="sd">            Input fit data.</span>

<span class="sd">        y : iterable, default=None</span>
<span class="sd">            Output fit data.</span>

<span class="sd">        **kwargs : dict of string -&gt; object</span>
<span class="sd">            Other input data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : PipeGraphClassifier</span>
<span class="sd">            This estimator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">node_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;_External&#39;</span> <span class="ow">in</span> <span class="n">node_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please use another name for the _External node. _External is used internally.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">add_mixins_to_step</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step_model</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">step_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>

        <span class="n">external_data</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">):</span> <span class="n">X</span><span class="p">,</span>
                         <span class="p">(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">):</span> <span class="n">y</span>
                        <span class="p">}</span>

        <span class="n">external_data</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="n">item</span>
                              <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span> <span class="o">=</span> <span class="n">external_data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="o">=</span> <span class="n">make_connections_when_not_provided_to_init</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_graph</span> <span class="o">=</span> <span class="n">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_predict_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_graph</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_graph</span> <span class="o">=</span> <span class="n">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_graph</span> <span class="o">=</span> <span class="n">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span><span class="p">)</span>

        <span class="n">fit_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_fit_nodes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="n">fit_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_single</span><span class="p">(</span><span class="n">step_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_fit_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fit_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_signature_values</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span><span class="p">,</span>
                                                  <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                                                  <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_inputs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: step.fit call ValueError!&quot;</span><span class="p">)</span>

        <span class="n">predict_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_signature_values</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span><span class="p">,</span>
                                                      <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                                                      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="o">**</span><span class="n">predict_inputs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: _fit.predict call ValueError!&quot;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_write_step_outputs</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span><span class="p">,</span>
                                 <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                                 <span class="n">output_data</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>

<div class="viewcode-block" id="PipeGraph.predict"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict the PipeGraph steps one after the other and following the topological</span>
<span class="sd">        order defined by the alternative_connections attribute, in case it is not None, or the connections attribute otherwise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: iterable object</span>
<span class="sd">            Data to predict on. Must fulfill input requirements of first step of the PipeGraph.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="s1">&#39;predict&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipeGraph.predict_proba"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies PipeGraph&#39;s predict method and returns the predict_proba output of the final estimator</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: iterable object</span>
<span class="sd">            Data to predict on. Must fulfill input requirements of first step of the PipeGraph.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_proba : array-like, shape = [n_samples, n_classes]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="s1">&#39;predict_proba&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipeGraph.decision_function"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.decision_function">[docs]</a>    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies PipeGraph&#39;s predict method and returns the decision_function output of the final estimator</span>

<span class="sd">         Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">         X: iterable object</span>
<span class="sd">            Data to predict on. Must fulfill input requirements of first step of the PipeGraph.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_score : array-like, shape = [n_samples, n_classes]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipeGraph.predict_log_proba"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.predict_log_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_log_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies PipeGraph&#39;s predict method and returns the predict_log_proba output of the final estimator</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: iterable object</span>
<span class="sd">            Data to predict on. Must fulfill input requirements of first step of the PipeGraph</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_proba : array-like, shape = [n_samples, n_classes]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="s1">&#39;predict_log_proba&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipeGraph.predict_dict"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.predict_dict">[docs]</a>    <span class="k">def</span> <span class="nf">predict_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict the PipeGraph steps one after the other and following the topological</span>
<span class="sd">        order defined by the alternative_connections attribute, in case it is not None, or the connections attribute otherwise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :</span>
<span class="sd">            Input data</span>
<span class="sd">        **kwargs : dict of string -&gt; object</span>
<span class="sd">             Arbitrary number of keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result_dict : dict</span>
<span class="sd">             Dictionary containing a single or multiple outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">external_data</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">):</span> <span class="n">X</span><span class="p">,</span>
                        <span class="p">}</span>

        <span class="n">external_data</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="n">item</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span> <span class="o">=</span> <span class="n">external_data</span>

        <span class="n">predict_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_predict_nodes</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">predict_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_predict_single_step</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">desired_output_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">desired_output_step</span><span class="p">,</span> <span class="n">label</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">,</span> <span class="s1">&#39;predict_log_proba&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">result_dict</span></div>

    <span class="k">def</span> <span class="nf">_predict_single_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">predict_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_signature_values</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span><span class="p">,</span>
                                                      <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                                                      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span>  <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="o">**</span><span class="n">predict_inputs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: _predict call ValueError!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_step_outputs</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>

<div class="viewcode-block" id="PipeGraph.fit_predict"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.fit_predict">[docs]</a>    <span class="k">def</span> <span class="nf">fit_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies fit_predict of last step in PipeGraph after it predicts the PipeGraph steps one after</span>
<span class="sd">        the other and following the topological order of the graph.</span>

<span class="sd">        Applies predict of a PipeGraph to the data following the topological order of the graph, followed by the</span>
<span class="sd">        fit_predict method of the final step in the PipeGraph. Valid only if the final step implements fit_predict.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: iterable object</span>
<span class="sd">            Training data. Must fulfill input requirements of first step of</span>
<span class="sd">            the pipeline.</span>
<span class="sd">        y : iterable, default=None</span>
<span class="sd">            Training targets. Must fulfill label requirements for all steps</span>
<span class="sd">            of the pipeline.</span>
<span class="sd">        **fit_params : dict of string -&gt; object</span>
<span class="sd">            Parameters passed to the ``fit`` method of each step, where</span>
<span class="sd">            each parameter name is prefixed such that parameter ``p`` for step</span>
<span class="sd">            ``s`` has key ``s__p``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipeGraph.score"><a class="viewcode-back" href="../../pipegraph.html#pipegraph.PipeGraph.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies PipeGraph&#39;s predict method and returns the score output of the final estimator</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">         X : iterable</span>
<span class="sd">             Data to predict on. Must fulfill input requirements of first step of the pipeGraph.</span>
<span class="sd">         y : iterable, default=None</span>
<span class="sd">            Targets used for scoring. Must fulfill label requirements for all steps of the pipeGraph.</span>
<span class="sd">         sample_weight : array-like, default=None</span>
<span class="sd">            If not None, this argument is passed as sample_weight keyword argument to the score method of the final estimator.</span>

<span class="sd">         Returns</span>
<span class="sd">         -------</span>
<span class="sd">         y_proba : array-like, shape = [n_samples, n_classes]</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">score_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_params</span><span class="p">[</span><span class="s1">&#39;sample_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_weight</span>
        <span class="n">final_step_name</span><span class="p">,</span> <span class="n">final_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">predict_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_signature_values</span><span class="p">(</span><span class="n">graph_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span><span class="p">,</span>
                                                  <span class="n">step_name</span><span class="o">=</span><span class="n">final_step_name</span><span class="p">,</span>
                                                  <span class="n">method</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">)</span>
        <span class="n">Xt</span> <span class="o">=</span> <span class="n">predict_inputs</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_and_outer_variable_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span><span class="p">[</span><span class="n">final_step_name</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_and_outer_variable_tuple</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_step</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">Xt</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">score_params</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">named_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Bunch</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_filter_fit_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_graph</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_filter_predict_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_graph</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_fetch_signature_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_data</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name:</span>

<span class="sd">        Returns:</span>
<span class="sd">        :rtype: dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_connections</span> <span class="k">if</span> <span class="n">graph_data</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_data</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_connections</span>
        <span class="n">connection_tuples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">connection_tuples</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
                <span class="n">connection_tuples</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">connection_tuples</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;_External&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)})</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">],</span> <span class="n">PipeGraph</span><span class="p">):</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">inner_variable</span><span class="p">:</span> <span class="n">graph_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_and_outer_variable_tuple</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">inner_variable</span><span class="p">,</span> <span class="n">node_and_outer_variable_tuple</span> <span class="ow">in</span> <span class="n">connection_tuples</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">input_data</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
            <span class="n">variable_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_fit_signature</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;predict&#39;</span><span class="p">:</span>
            <span class="n">variable_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps_dict</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_predict_signature</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">variable_list</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">inner_variable</span><span class="p">:</span> <span class="n">graph_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_and_outer_variable_tuple</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">inner_variable</span><span class="p">,</span> <span class="n">node_and_outer_variable_tuple</span> <span class="ow">in</span> <span class="n">connection_tuples</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">input_data</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">inner_variable</span><span class="p">:</span> <span class="n">graph_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_and_outer_variable_tuple</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">inner_variable</span><span class="p">,</span> <span class="n">node_and_outer_variable_tuple</span> <span class="ow">in</span> <span class="n">connection_tuples</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                      <span class="k">if</span> <span class="n">inner_variable</span> <span class="ow">in</span> <span class="n">variable_list</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">input_data</span>

    <span class="k">def</span> <span class="nf">_write_step_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_data</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">output_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            node_name:</span>
<span class="sd">            data_dict:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span> <span class="n">value</span> <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="n">connections</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        connections: dict</span>
<span class="sd">        A dictionary as described in PipeGraphRegressor and PipeGraphClassifier</span>

<span class="sd">    Returns:</span>
<span class="sd">        A graph ready to be fitted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="s1">&#39;_External&#39;</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please use another name for the _External node. _External name is used internally.&quot;</span><span class="p">)</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">current_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">ascendants_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inner_variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">ascendants_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
                <span class="n">ascendants_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">ascendants_set</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s1">&#39;_External&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ascendant</span> <span class="ow">in</span> <span class="n">ascendants_set</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">ascendant</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span>



<span class="k">def</span> <span class="nf">add_mixins_to_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">mixin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function adds mixin classes to models in order to provide a common interface for them all.</span>
<span class="sd">    This interface declares two main methods: fit and predict. So, no matter whether the adaptee is capable of doing</span>
<span class="sd">    predict, transform or fit_predict, once the mixin class is added the model is capable</span>
<span class="sd">    of using pg_predict as method for producing output.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">        step: a Scikit-Learn object, for instance; or a user made custom estimator may be.</span>
<span class="sd">        mixin: A user made class; or one already defined in pipegraph.adapters.</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">        The step object transformed by adding a mixing class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mixin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_a_mixin_not_needed</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">AdapterMixins</span><span class="p">)</span> <span class="ow">or</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">PipeGraph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_a_mixin_not_needed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">step</span>
        <span class="k">elif</span> <span class="n">step</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">strategies_for_custom_adaptees</span><span class="p">:</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">strategies_for_custom_adaptees</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">FitPredictMixin</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">):</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">FitTransformMixin</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;fit_predict&#39;</span><span class="p">):</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">AtomicFitPredictMixin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: Unknown step class!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">mixin</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">step</span>

    <span class="n">new_class_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">step</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_class_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="n">mixin</span><span class="p">),</span> <span class="p">{})</span>
    <span class="k">return</span> <span class="n">step</span>


<span class="k">def</span> <span class="nf">make_connections_when_not_provided_to_init</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: No steps to chain. Please provide a list of steps to PipeGraph&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;predict&#39;</span><span class="p">)}</span>

    <span class="n">connections</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">connections</span>


<span class="k">class</span> <span class="nc">Concatenator</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate a set of data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method that does, in this case, nothing but returning self.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            self : returns an instance of _Concatenator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the input data type for correct concatenating.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :  sequence of indexables with same length / shape[0]</span>
<span class="sd">            Allowed inputs are lists, numpy arrays, scipy-sparse</span>
<span class="sd">            matrices or pandas dataframes.</span>
<span class="sd">            Data to concatenate.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Pandas series or Pandas DataFrame with the data input concatenated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ColumnSelector</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Slice data-input data in columns</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mapping : list. Each element contains data-column and the new name assigned</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : returns an instance of _CustomPower.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        X: iterable object</span>
<span class="sd">                Data to slice.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        returns a list with data-column and the new name assigned for each column selected</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;predict&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">column_slice</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">column_slice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">Reshape</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Demultiplexer</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Slice data-input data in columns</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mapping : list. Each element contains data-column and the new name assigned</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">selection</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">class_number</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">class_number</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">class_number</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span> <span class="o">==</span> <span class="n">class_number</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">Multiplexer</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># list of arrays with the same dimension</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">selection</span>

        <span class="n">array_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">class_number</span><span class="p">)],</span>
                                   <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">selection</span> <span class="o">==</span> <span class="n">class_number</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">class_number</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">selection</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">array_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">RegressorsWithParametrizedNumberOfReplicas</span><span class="p">(</span><span class="n">PipeGraph</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_replicas</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">regressor</span><span class="o">=</span><span class="n">LinearRegression</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_replicas</span> <span class="o">=</span> <span class="n">number_of_replicas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">regressor</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">([(</span><span class="s1">&#39;demux&#39;</span><span class="p">,</span> <span class="n">Demultiplexer</span><span class="p">())]</span> <span class="o">+</span>
                 <span class="p">[(</span><span class="s1">&#39;regressor_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">regressor</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_replicas</span><span class="p">)]</span> <span class="o">+</span>
                 <span class="p">[(</span><span class="s1">&#39;mux&#39;</span><span class="p">,</span> <span class="n">Multiplexer</span><span class="p">())]</span>
                 <span class="p">)</span>

        <span class="n">connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">demux</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="s1">&#39;selection&#39;</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_replicas</span><span class="p">):</span>
            <span class="n">connections</span><span class="p">[</span><span class="s1">&#39;regressor_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;demux&#39;</span><span class="p">,</span> <span class="s1">&#39;X_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                                               <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;demux&#39;</span><span class="p">,</span> <span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))}</span>

        <span class="n">connections</span><span class="p">[</span><span class="s1">&#39;mux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;regressor_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_replicas</span><span class="p">)}</span>
        <span class="n">connections</span><span class="p">[</span><span class="s1">&#39;mux&#39;</span><span class="p">][</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;selection&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">fit_connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RegressorsWithDataDependentNumberOfReplicas</span><span class="p">(</span><span class="n">PipeGraph</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;regressor&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">()</span> <span class="p">)]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">selection</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">regressor</span>
        <span class="n">number_of_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
        <span class="n">multiple_regressors</span> <span class="o">=</span> <span class="n">RegressorsWithParametrizedNumberOfReplicas</span><span class="p">(</span><span class="n">number_of_replicas</span><span class="o">=</span><span class="n">number_of_clusters</span><span class="p">,</span>
                                                                         <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;regressorsBundle&#39;</span><span class="p">,</span> <span class="n">multiple_regressors</span><span class="p">)]</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">regressorsBundle</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="s1">&#39;selection&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipegraph</span> <span class="o">=</span> <span class="n">PipeGraph</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">fit_connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipegraph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipegraph</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">query_number_of_clusters_from_classifier</span><span class="p">(</span><span class="n">classifier</span><span class="p">):</span>

    <span class="n">number_of_clusters_dictionary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;KMeans&#39;</span><span class="p">:</span> <span class="s1">&#39;n_clusters&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SpectralClustering&#39;</span><span class="p">:</span> <span class="s1">&#39;n_clusters&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AgglomerativeClustering&#39;</span><span class="p">:</span> <span class="s1">&#39;n_clusters&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GaussianMixture&#39;</span><span class="p">:</span> <span class="s1">&#39;n_components&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Birch&#39;</span><span class="p">:</span> <span class="s1">&#39;n_clusters&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">classifier_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">number_of_clusters_str</span> <span class="o">=</span> <span class="n">number_of_clusters_dictionary</span><span class="p">[</span><span class="n">classifier_class</span><span class="p">]</span>
    <span class="n">number_of_cluster</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">get_params</span><span class="p">()[</span><span class="n">number_of_clusters_str</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">number_of_cluster</span>

<span class="k">class</span> <span class="nc">ClassifierAndRegressorsBundle</span><span class="p">(</span><span class="n">PipeGraph</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">GaussianMixture</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;regressor&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">())]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">classifier</span>
        <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">regressor</span>
        <span class="n">number_of_clusters</span> <span class="o">=</span> <span class="n">query_number_of_clusters_from_classifier</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>
        <span class="n">multiple_regressors</span> <span class="o">=</span> <span class="n">RegressorsWithParametrizedNumberOfReplicas</span><span class="p">(</span><span class="n">number_of_replicas</span><span class="o">=</span><span class="n">number_of_clusters</span><span class="p">,</span>
                                                                         <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">)</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">classifier</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;regressorsBundle&#39;</span><span class="p">,</span> <span class="n">multiple_regressors</span><span class="p">)]</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classifier</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">},</span>
                           <span class="n">regressorsBundle</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="s1">&#39;classifier&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adaptee</span> <span class="o">=</span> <span class="n">PipeGraph</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">fit_connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_adaptee</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptee</span><span class="o">.</span><span class="n">predict_dict</span><span class="p">(</span><span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NeutralRegressor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">X</span>


<span class="k">class</span> <span class="nc">NeutralClassifier</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">X</span>



<span class="kn">from</span> <span class="nn">pipegraph.adapters</span> <span class="k">import</span> <span class="p">(</span><span class="n">FitTransformMixin</span><span class="p">,</span>
                                <span class="n">FitPredictMixin</span><span class="p">,</span>
                                <span class="n">AtomicFitPredictMixin</span><span class="p">,</span>
                                <span class="n">CustomFitPredictWithDictionaryOutputMixin</span><span class="p">)</span>

<span class="n">strategies_for_custom_adaptees</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">NeutralRegressor</span><span class="p">:</span>  <span class="n">FitPredictMixin</span><span class="p">,</span>
    <span class="n">NeutralClassifier</span><span class="p">:</span>  <span class="n">FitPredictMixin</span><span class="p">,</span>
    <span class="n">Concatenator</span><span class="p">:</span> <span class="n">FitPredictMixin</span><span class="p">,</span>
    <span class="n">ColumnSelector</span><span class="p">:</span> <span class="n">CustomFitPredictWithDictionaryOutputMixin</span><span class="p">,</span>
    <span class="n">Reshape</span><span class="p">:</span> <span class="n">FitPredictMixin</span><span class="p">,</span>
    <span class="n">Demultiplexer</span><span class="p">:</span> <span class="n">CustomFitPredictWithDictionaryOutputMixin</span><span class="p">,</span>
    <span class="n">Multiplexer</span><span class="p">:</span> <span class="n">FitPredictMixin</span><span class="p">,</span>
<span class="p">}</span>

<span class="kn">from</span> <span class="nn">pipegraph.demo_blocks</span> <span class="k">import</span> <span class="n">strategies_for_demo_blocks_adaptees</span>
<span class="n">strategies_for_custom_adaptees</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">strategies_for_demo_blocks_adaptees</span><span class="p">)</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, The authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>